'use client';

import { useAtom } from 'jotai';
import { useEffect, useTransition, useCallback } from 'react';
import { signInWithCredentials } from '@/services/auth/auth_signin_POST';
import { logout as logoutAction } from '@/services/auth/auth_logout_GET';
import { refreshTokenWithString } from '@/services/auth/auth_refresh_POST';
import { isAuthenticatedAtom, userAtom, parkingLotsAtom, selectedParkingLotIdAtom } from '@/store/auth';
import { loadMenuDataAtom } from '@/store/menu';

/**
 * ì¿ í‚¤ì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
 */
const getTokenFromCookie = (tokenName: string): string | null => {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith(`${tokenName}=`))
    ?.split('=')[1] || null;
};

/**
 * ì¿ í‚¤ì— í† í° ì„¤ì •
 */
const setTokenToCookie = (tokenName: string, token: string, maxAge: number = 86400) => {
  document.cookie = `${tokenName}=${token}; path=/; max-age=${maxAge}`;
};

/**
 * ì¿ í‚¤ì—ì„œ í† í° ì œê±°
 */
const removeTokenFromCookie = (tokenName: string) => {
  document.cookie = `${tokenName}=; path=/; max-age=0`;
};

/**
 * ì „ì—­ ìƒíƒœ ê¸°ë°˜ ì¸ì¦ í›…
 */
export function useAuth() {
  const [isPending, startTransition] = useTransition();
  const [isLoggedIn, setIsLoggedIn] = useAtom(isAuthenticatedAtom);
  const [user, setUser] = useAtom(userAtom);
  const [parkingLots, setParkingLots] = useAtom(parkingLotsAtom);
  const [selectedParkingLotId, setSelectedParkingLotId] = useAtom(selectedParkingLotIdAtom);
  const [, loadMenuData] = useAtom(loadMenuDataAtom); // ê°„ë‹¨í•œ ë©”ë‰´ ë¡œë”© ì•¡ì…˜

  /**
   * í† í° ìë™ ê°±ì‹ 
   */
  const refreshToken = useCallback(async (): Promise<boolean> => {
    const refreshTokenString = getTokenFromCookie('refresh-token');
    
    if (!refreshTokenString) {
      return false;
    }

    try {
      const result = await refreshTokenWithString(refreshTokenString);
      
      if (result.success && result.data) {
        // ìƒˆë¡œìš´ í† í°ë“¤ ì €ì¥
        setTokenToCookie('access-token', result.data.accessToken);
        setTokenToCookie('refresh-token', result.data.refreshToken);
        
        // í˜„ì¥ ì •ë³´(ì£¼ì°¨ì¥) ì—…ë°ì´íŠ¸ - ë¡œê·¸ì¸ ì‹œ ë¯¸ë¦¬ ë°›ëŠ” ì •ë³´
        if (result.data.parkinglots) {
          setParkingLots(result.data.parkinglots);
        }
        
        // parkingLotId ì²˜ë¦¬ - ìŠˆí¼ì–´ë“œë¯¼(0) ë˜ëŠ” ì¼ë°˜ì‚¬ìš©ìì˜ ê¸°ë³¸ í˜„ì¥
        let finalParkingLotId: number | null = null;
        if (result.data.parkingLotId !== undefined) {
          finalParkingLotId = result.data.parkingLotId;
          setSelectedParkingLotId(result.data.parkingLotId);
        } else if (result.data.parkinglots && result.data.parkinglots.length === 1) {
          // APIì—ì„œ parkingLotIdë¥¼ ëª…ì‹œí•˜ì§€ ì•Šì•˜ì§€ë§Œ í˜„ì¥ì´ 1ê°œë¿ì¸ ê²½ìš° ìë™ ì„ íƒ
          finalParkingLotId = result.data.parkinglots[0].id;
          setSelectedParkingLotId(result.data.parkinglots[0].id);
        } else if (result.data.parkinglots && result.data.parkinglots.length > 1) {
          // ì—¬ëŸ¬ í˜„ì¥ì´ ìˆëŠ” ê²½ìš° ìŠˆí¼ì–´ë“œë¯¼ìœ¼ë¡œ ê°„ì£¼í•˜ê³  0 ì„¤ì •
          finalParkingLotId = 0;
          setSelectedParkingLotId(0);
        }
        
        // ğŸ¯ í† í° ê°±ì‹  ì™„ë£Œ í›„ ë©”ë‰´ ì´ˆê¸°í™”
        if (finalParkingLotId !== null) {
          const menuParkingLotId = finalParkingLotId > 0 ? finalParkingLotId : undefined;
          await loadMenuData(menuParkingLotId);
        }
        
        return true;
      }
      
      return false;
    } catch {
      return false;
    }
  }, [setParkingLots, loadMenuData]); // initializeMenuAfterLogin ì œê±°

  // ì´ˆê¸° í† í° í™•ì¸ ë° ìë™ ê°±ì‹  ì„¤ì •
  useEffect(() => {
    const accessToken = getTokenFromCookie('access-token');
    const refreshTokenString = getTokenFromCookie('refresh-token');
    
    // ì¿ í‚¤ í† í° ìœ ë¬´ì™€ ë¡œê·¸ì¸ ìƒíƒœ ë™ê¸°í™”
    if (accessToken && !isLoggedIn) {
      setIsLoggedIn(true);
    } else if (!accessToken && isLoggedIn) {
      // accessTokenì´ ì—†ìœ¼ë©´ refresh ì‹œë„
      if (refreshTokenString) {
        refreshToken().then((success) => {
          if (!success) {
            // refresh ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì•„ì›ƒ
            setIsLoggedIn(false);
            setUser(null);
            setParkingLots([]);
            setSelectedParkingLotId(null);
          }
        });
      } else {
        // refresh tokenë„ ì—†ìœ¼ë©´ ë¡œê·¸ì•„ì›ƒ
        setIsLoggedIn(false);
        setUser(null);
        setParkingLots([]);
        setSelectedParkingLotId(null);
      }
    }
  }, [isLoggedIn, setIsLoggedIn, setUser, setParkingLots, setSelectedParkingLotId, refreshToken]);

  // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ë©”ë‰´ ë¡œë”©
  useEffect(() => {
    if (isLoggedIn && selectedParkingLotId !== null) {
      const menuParkingLotId = selectedParkingLotId > 0 ? selectedParkingLotId : undefined;
      loadMenuData(menuParkingLotId);
    }
  }, [isLoggedIn, selectedParkingLotId, loadMenuData]);

  /**
   * ë¡œê·¸ì¸
   */
  const login = async (account: string, password: string) => {
    const result = await signInWithCredentials(account, password);

    if (!result.success) {
      return { success: false, error: result.errorMsg || 'ë¡œê·¸ì¸ ì‹¤íŒ¨' };
    }

    if (!result.data?.accessToken) {
      return { success: false, error: 'í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤' };
    }

    // í† í°ë“¤ì„ ì¿ í‚¤ì— ì €ì¥
    setTokenToCookie('access-token', result.data.accessToken);
    
    if (result.data.refreshToken) {
      setTokenToCookie('refresh-token', result.data.refreshToken);
    }
    
    // ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
    setIsLoggedIn(true);
    
    // í˜„ì¥ ì •ë³´(ì£¼ì°¨ì¥) ì„¤ì •
    if (result.data.parkinglots) {
      setParkingLots(result.data.parkinglots);
    }
    
    // parkingLotId ì²˜ë¦¬
    let finalParkingLotId: number | null = null;
    if (result.data.parkingLotId !== undefined) {
      finalParkingLotId = result.data.parkingLotId;
      setSelectedParkingLotId(result.data.parkingLotId);
    } else if (result.data.parkinglots && result.data.parkinglots.length === 1) {
      finalParkingLotId = result.data.parkinglots[0].id;
      setSelectedParkingLotId(result.data.parkinglots[0].id);
    } else if (result.data.parkinglots && result.data.parkinglots.length > 1) {
      finalParkingLotId = 0;
      setSelectedParkingLotId(0);
    }

    // ğŸ¯ ë©”ë‰´ ë¡œë”© - ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ë°©ë²•
    if (finalParkingLotId !== null) {
      const menuParkingLotId = finalParkingLotId > 0 ? finalParkingLotId : undefined;
      await loadMenuData(menuParkingLotId);
    }

    return { success: true };
  };

  /**
   * ì£¼ì°¨ì¥ ì„ íƒ
   */
  const selectParkingLot = useCallback((parkingLotId: number) => {
    setSelectedParkingLotId(parkingLotId);
  }, [setSelectedParkingLotId]);

  /**
   * ì„ íƒëœ ì£¼ì°¨ì¥ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
   */
  const getSelectedParkingLot = useCallback(() => {
    if (!selectedParkingLotId) return null;
    return parkingLots.find(lot => lot.id === selectedParkingLotId) || null;
  }, [selectedParkingLotId, parkingLots]);

  /**
   * ë¡œê·¸ì•„ì›ƒ
   */
  const logout = async () => {
    startTransition(async () => {
      await logoutAction();
      
      // ì¿ í‚¤ ì œê±°
      removeTokenFromCookie('access-token');
      removeTokenFromCookie('refresh-token');
      
      // ìƒíƒœ ì´ˆê¸°í™”
      setIsLoggedIn(false);
      setUser(null);
      setParkingLots([]);
      setSelectedParkingLotId(null);
    });
  };

  return {
    isLoggedIn,
    isLoading: false,
    login,
    logout,
    refreshToken,
    isPending,
    user,
    parkingLots,
    selectedParkingLotId,
    selectedParkingLot: getSelectedParkingLot(),
    selectParkingLot,
  };
} 